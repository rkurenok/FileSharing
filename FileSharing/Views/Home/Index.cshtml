@{
    ViewBag.Title = "Home Page";
    string text = "Если файл имеет тип доступа \"Закрытый\", то доступ к этому файлу имеете только вы в своем профиле, а если файл имеет тип доступа \"Открытый\", то доступ к нему имеют все пользователи во вкладке \"Файлы\"";
}
<p class="text-success">@ViewBag.StatusMessage</p>
@*<h2>Главная страница</h2>

@ViewBag.Result*@

<h3 class="text-center">Выберите файл для загрузки</h3>
@*<button type="button" id="glyphiconAdd">
        <span class="glyphicon glyphicon-plus-sign" aria-hidden="true" style="font-size: 250%"></span>
    </button>*@
<div style="margin:0 auto;">
    <div id="upload" class="text-center" style=" margin: auto;">
        @using (Html.BeginForm("Upload", "File", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            if (User.Identity.IsAuthenticated)
            {
                <br />
                <div>
                    @*<input type="file" name="uploads" multiple>
                        <br>*@
                    <input type="file" name="uploads" id="file-lg" class="file-select file-select-lg" multiple />
                    <label for="file-lg" class="filename">
                        <i class="fa fa-arrow-circle-o-up"></i>
                        Выберите файлы...
                    </label>
                    <p id="result"></p>
                    <br />
                    <div>
                        <div>
                            <h4>Доступ к файлу</h4>
                        </div>
                        <!-- Material checked -->
                        @*<div class="form-check">
                                <label class="form-check-label" for="materialChecked">Закрытый</label>
                                <input type="radio" class="form-check-input" id="materialChecked" name="access" checked>
                            </div>*@
                        <!-- Material unchecked -->
                        @*<div class="form-check">
                                <input type="radio" class="form-check-input" id="materialUnchecked" name="access">
                                <label class="form-check-label" for="materialUnchecked">Открытый</label>
                            </div>*@
                        <div class="btn-group" data-toggle="buttons">
                            <label class="btn btn-primary active">
                                <input type="radio" name="access" id="option1" autocomplete="off" value="private" checked> Закрытый
                            </label>
                            <label class="btn btn-primary">
                                <input type="radio" name="access" id="option2" autocomplete="off" value="public"> Открытый
                            </label>
                        </div>
                        <span id="btn-tooltip" class="glyphicon glyphicon-question-sign btn-secondary" data-toggle="tooltip" data-placement="right" title="@text"></span>
                        @*<div id="access">
                                Закрытый
                                @Html.RadioButton("access", "private", true, htmlAttributes: new { @id = "materialChecked" }) &nbsp;
                                Открытый
                                @Html.RadioButton("access", "public")
                            </div>*@
                        <br />
                        <br />
                        <div>
                            <h4>Срок хранения файла</h4>
                        </div>
                        @*3 дня
                            @Html.RadioButton("retentionPeriodId", 1, true) &nbsp;
                            7 дней
                            @Html.RadioButton("retentionPeriodId", 2) &nbsp;
                            1 месяц
                            @Html.RadioButton("retentionPeriodId", 3) &nbsp;*@
                        <div class="btn-group" data-toggle="buttons">
                            <label class="btn btn-primary active">
                                <input type="radio" name="retentionPeriodId" id="option1" autocomplete="off" value=1 checked> 3 дня
                            </label>
                            <label class="btn btn-primary">
                                <input type="radio" name="retentionPeriodId" id="option2" autocomplete="off" value=2> 7 дней
                            </label>
                            <label class="btn btn-primary">
                                <input type="radio" name="retentionPeriodId" id="option2" autocomplete="off" value=3> 1 месяц
                            </label>
                        </div>
                    </div>
                    <br />
                </div>
            }
            else
            {
                <input type="file" name="uploads">
                <br>
                <div id="access" style="display: none">
                    <div>
                        Доступ к файлу
                    </div>
                    <div>
                        @*@Html.Label("Access", "Открытый")*@
                        Закрытый
                        @Html.RadioButton("access", "private", true) &nbsp;
                        Открытый
                        @Html.RadioButton("access", "public")
                    </div>
                    <div>
                        Срок хранения файла
                    </div>
                    10 секунд
                    @Html.RadioButton("retentionPeriodId", 1, true) &nbsp;
                    30 секунд
                    @Html.RadioButton("retentionPeriodId", 2) &nbsp;
                    1 минуту
                    @Html.RadioButton("retentionPeriodId", 3) &nbsp;
                </div>

            }
            <input type="submit" class="btn btn-primary" value="Загрузить" />
        }
        @{
            string link;
        }
        @if (ViewBag.File != null)
        {
            @ViewBag.File.Name
            <br />
            @Html.ActionLink("Сгенерировать ссылку для скачивания", "GetFileDownloadLink", "File", new { fileId = ViewBag.File.Id }, null)
            <br />
            if (ViewBag.File.FileUniqueKeyId != null)
            {
                foreach (var uniqueKey in ViewBag.FileUniqueKeys)
                {
                    if (ViewBag.File.FileUniqueKeyId == uniqueKey.Id)
                    {
                        link = Url.Content("https://localhost:44301/File/DownloadByLink?fileId=" + ViewBag.File.Id + '&' + "uniqueKey=" + uniqueKey.UniqueKey);
                        @*@Html.ActionLink("Скачать через ссылку", "DownloadByLink", "File", new { fileId = item.Id, uniqueKey = uniqueKey.UniqueKey }, null)*@
                        <a id="linkFile" onclick="copyToClipboard()">@link</a>
                        <br />
                        <div>Нажмите на ссылку, чтобы скопировать ее</div>
                    }
                }
            }
        }
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        @*var access = document.getElementById("access");
        access.hidden = true;
        if (@User.Identity.IsAuthenticated) {
            //access.style.display = "block";
            access.hidden = false;
        }*@

        function copyToClipboard() {
            var copytext = document.createElement('input')
            copytext.value = document.getElementById("linkFile").innerHTML.toString();
            document.body.appendChild(copytext)
            copytext.select()
            document.execCommand('copy')
            document.body.removeChild(copytext)
        }

        document.addEventListener('copy', function (e) {

            // Нам необходимо предотвратить стандартное копирование,
            // иначе все просто скопируется как обычно.
            e.preventDefault();

            // Событие не дает нам доступ к буферу поэтому
            // нам надо добавить выделение с помощью Selection API.
            var selection = window.getSelection().toString();

            // Трансформируем выделенное как хотим
            var linkText = selection.replace("&amp;", "&");

            // Вставляем измененный текст в буфер.
            e.clipboardData.setData('text/plain', linkText);

        })

        //$(function () {
        //    $("input:file").change(function () {
        //        var fileName = $(this).val().split('\\').pop();
        //        $(this).next('label').html('<i class="fa fa-file"></i> ' + fileName);
        //    });
        //});

        $(document).ready(function () {

            $("input:file").change(function () { // Выполняем функцию после выбора файлов

                //var name_file = []; // Создаем массив

                //for (var i = 0; i < $(this).get(0).files.length; ++i) { // Запускаем цикл и перебираем все файлы

                //    name_file.push($(this).get(0).files[i].name); // Добавляем имена файлов в массив
                //}
                //$("#result").html('<span class="glyphicon glyphicon-file"></span> ' + name_file.join("</br> "));

                var name_files = [];
                var arrayHtml = '<div>массив: </div>';
                var selectionHtml = 'Выбранные файлы: </br>';
                for (var i = 0; i < $(this).get(0).files.length; ++i) {
                    name_files[i - 1] = $(this).get(0).files[i].name;
                    selectionHtml += '<span class="glyphicon glyphicon-file"></span>' + name_files[i - 1] + '</br>';
                }
                $("#result").html(selectionHtml);
            });

        });
        $('[data-toggle="tooltip"]').tooltip();
    </script>
}
